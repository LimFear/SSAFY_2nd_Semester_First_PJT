# 🚀 팀원용 통합 프로젝트 가이드 (Teammate_PJT) - v2.2 Full Edition

이 폴더는 네가 작업했던 기존 `DHT11` 프로젝트를 기반으로 **조도(CDS) 센서**를 합치고, 최신 운영 정책인 **v2.2(기능 안전 및 무결성 강화)** 규격을 완벽하게 적용한 최종 버전이야. 

기존 `DHT11` 코드와 비교해서 **하드웨어 연결부터 통신 로직까지 정말 많은 게 바뀌었으니**, 아래 내용을 꼭 하나씩 체크해줘!

---

## 📂 폴더 구성 (노드 분리)
- **esp32_sensor/**: 아두이노 IDE용 - **온습도/조도 데이터 송신 노드**
- **esp32_actuator/**: 아두이노 IDE용 - **LED/서보 제어 및 안전 판단 노드**
- **stm32_gateway/**: STM32CubeIDE용 - **시스템 전체 판단 노드**

---

## 🔄 기존 DHT11 대비 모든 변경 사항 (Full List)

### 1. 통신 무결성 강화 (E2E-lite 적용)
-   **기존**: 단순히 데이터만 500ms마다 송신.
-   **v2.2 변경**: 모든 메시지에 **ISO 26262** 기준의 무결성 필드 추가.
    -   **B0 (Sender ID)**: 누가 보낸 데이터인지 명시 (Sensor=1).
    -   **B1 (Rolling Counter)**: 데이터 누락이나 중복을 막기 위한 순서 번호.
    -   **B7 (CRC8)**: 데이터가 전선 노이즈로 깨졌는지 검증하는 체크섬 (0x07 다항식 사용).
-   **이유**: 게이트웨이(STM32)가 잘못된 데이터를 읽고 와이퍼나 LED를 오동작시키는 것을 100% 방지하기 위함이야.

### 2. 데이터 규격 및 단위 통일
-   **온도**: 기존 x10 정수/소수 분할 -> **`°C * 100` (int16)** 방식으로 정밀도 통합. (B2~3 사용)
-   **조도 (신규)**: `SNS_LUX (0x220)` 메시지 추가. Raw ADC가 아닌 Lux 관련 데이터 전송. (B2~3 사용)
-   **습도**: 0~100 사이의 정수 전송. (B4 사용)

### 3. 기능 안전 로직 (Safety & FAILSAFE)
-   **게이트웨이 상태 감시**: 이제 게이트웨이가 1초마다 생존 신호(`GW_STATE`)를 보내.
-   **독립 FAILSAFE (신규)**: 액츄에이터가 게이트웨이 신호를 3초 이상 못 받으면? **스스로 모든 동작을 중단(Safe State)**하고 대기해.
-   **생존 보고 (ALIVE)**: 센서 노드가 1초마다 본인의 존재 여부(`SNS_ALIVE`)를 보고하도록 추가했어.

### 4. 코드 구동 방식 변화 (Timing)
-   **기존**: `delay(500)` 등을 사용하여 루프가 멈춤.
-   **v2.2 변경**: `millis()` 기반의 **논블로킹(Non-blocking)** 타이머 사용.
-   **이유**: 데이터를 보내는 동안에도 CAN 메시지 수신(명령)을 단 1ms도 놓치지 않기 위해서야.

### 5. 하드웨어 핀 맵 조정 (필독!!)
시스템 통합 과정에서 핀 충돌을 막기 위해 다음과 같이 조정했어. 연결할 때 꼭 확인해줘!

| 장치 | 핀 번호 | 변경 사유 |
| :--- | :--- | :--- |
| **DHT11 (Data)** | **14** | 기존 3번은 시리얼(UART) 포트와 간섭 위험이 커서 변경함 |
| **조도 센서 (ADC)** | **34** | ESP32에서 가장 안정적인 ADC1 채널 사용 |
| **RGB LED (Actuator)** | **4, 5, 18** | 중용 제어를 위한 신규 핀 할당 |
| **Servo (Actuator)** | **17** | 서보 제어 전용 핀 |
| **CAN TX/RX** | **33, 32** | 기존 유지 |

---

## 🔍 핵심 파일 가이드 (무엇을 봐야 하나요?)

전체 코드가 복잡해 보일 수 있지만, 아래 **4개 파일**만 중점적으로 보면 동작 원리를 완벽하게 이해할 수 있어!

1.  **[esp32_sensor.ino]
    -   **역할**: 온습도/조도 수집 및 **CRC8 체크섬** 생성 로직.
    -   **포인트**: 데이터를 어떻게 v2.2 규격으로 포장(Packing)해서 쏘는지 확인해봐.

2.  **[esp32_actuator.ino]
    -   **역할**: 게이트웨이 명령 수신 및 **독립 FAILSAFE(3초 감시)** 로직.
    -   **포인트**: 게이트웨이가 응답 없을 때 스스로 어떻게 안전 모드로 변하는지 확인해봐.

3.  **[decision.h]
    -   **역할**: 모든 통신 규격이 정의된 **'데이터 계약서'**.
    -   **포인트**: 수신된 데이터의 무결성(CRC8)을 검증하는 파싱 함수들이 들어있어.

4.  **[freertos.c]
    -   **역할**: 시스템 전체의 **판단 주체(게이트웨이)** 메인 로직.
    -   **포인트**: 센서 데이터를 받아서 언제 라이트를 켜고 언제 ESTOP을 선언하는지 전반적인 흐름을 알 수 있어.

---

## 🛠️ 팀원용 팁 (FAQ)

-   **MQTT는 어디 갔나요?**: 이번 시스템의 핵심은 'CAN 기반 실시간 제어'야. WiFi와 MQTT는 CAN 통신의 실시간 성능을 방해할 수 있어서(아두이노 한계), 일단은 CAN 시스템의 완성도를 위해 제외했어.
-   **Protocol Error가 떠요!**: 만약 게이트웨이 시리얼 창에 `Protocol Error`가 뜨면, 네가 보낸 데이터의 CRC나 Sender ID가 정책v2.2와 안 맞는다는 뜻이야. 내가 보내준 소스 코드를 그대로 쓰면 문제없을 거야!

---